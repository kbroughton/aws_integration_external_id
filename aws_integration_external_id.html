<!DOCTYPE html>
<!-- https://www.youtube.com/watch?v=VJj-H4we71g -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.8.8/brython.js" integrity="sha256-rA89wPrTJJQFWJaZveKW8jpdmC3t5F9rRkPyBjz8G04=" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.8.8/brython_stdlib.js" integrity="sha256-Gnrw9tIjrsXcZSCh/wos5Jrpn0bNVNFJuNJI9d71TDs=" crossorigin="anonymous"></script>

    <style>
        * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
          font-family: Arial, Helvetica, sans-serif;
          font-size: 25px;
          padding: 30px;
          line-height: 1.6;
      }

      small {
          font-family: Arial, Helvetica, sans-serif;
          font-size: 15px;
          padding: 20px;
          line-height: 1.1;
      }

      very-small {
          font-family: Arial, Helvetica, sans-serif;
          font-size: 10px;
          padding: 2px;
          line-height: 0.9;
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 1px #ccc solid;
      }

      h2 {
        margin-top: 20px;
      }
    
    .grey-input {
        background-color: #e7e7e7; 
        color: black; /* Gray */
        margin: 1px 0;
        padding: 1px 1px;
        width: 350px;   
        display: block;

        } 

    .policy {
        background-color: #e7e7e7; 
        color: black; /* Gray */
        margin: 1px 0;
        padding: 1px 1px;
        width: 550px;   
        display: block;

        } 

        button {
        cursor: pointer;
        display: inline-block;
        background-color: #24a0ed; 
        border: 0;
        border-radius: 5px;
        padding: 10px 20px;
        margin: 20px 0;
      }

        .green-button {
        cursor: pointer;
        display: inline-block;
        background-color: #4CAF50; /* Green */
        border: 0;
        border-radius: 5px;
        padding: 10px 20px;
        margin: 20px 0;
      }

        .red-button {
        cursor: pointer;
        display: inline-block;
        background-color: #FC8080; /* Green */
        border: 0;
        border-radius: 5px;
        padding: 10px 20px;
        margin: 20px 0;
      }      

      input[type="text"] {
        border: 1px #ccc solid;
        width: 300px;
        padding: 4px;
        height: 35px;
        margin-top: 10px;
        opacity: 0.5;
      }



    #overlay {
      display: none;
      position: absolute;
      width: 100px;
      height: 100px;
      background-color: gray;
      top: 50px;
      left: 50px;
      padding: 10px;
      opacity: .8;
    }
      .card {
        margin: 20px 0;
        border: #ccc 1px solid;
        padding: 20px;
      }

      .box {
          background: steelblue;
          width: 1.6em;
          height: 1.6em;
      }

  .switch-toggle {
     float: left;
     background: #242729;
  }
  .switch-toggle input {
    position: absolute;
    opacity: 0;
  }
  .switch-toggle input + label {
    padding: 7px;
    float:left;
    color: #fff;
    cursor: pointer;
  }
  .switch-toggle input:checked + label {
    background: green;
}
.highlighted {
  background-color: #ff0;
}
/* Tooltip container */
.tooltip {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted black; /* If you want dots under the hoverable text */
}

/* Tooltip text */
.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: #555;
  color: #fff;
  text-align: center;
  padding: 5px 0;
  border-radius: 6px;

  /* Position the tooltip text */
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;

  /* Fade in tooltip */
  opacity: 0;
  transition: opacity 0.3s;
}

/* Tooltip arrow */
.tooltip .tooltiptext::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: #555 transparent transparent transparent;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

    </style>

        <script data-require="jquery" data-semver="2.0.3" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>

    <script type="text/javascript" id="uuid_script">
        function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
        });
        }
        var uuid_val = uuidv4();
        console.log("uuidv4 javascript " + uuid_val);
        document.getElementById("input_external_id").innerHTML = uuid_val;

    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.js"></script>

    <title>Confused Deputy Demo</title>

    </head>
    <body onload="brython()">
        <h1>Super Secure Your Cloud We Will Make</h1>

     <div class="switch-toggle switch-3 switch-candy">

      <input id="trivial" name="state-d" type="radio" checked="checked" />
      <label for="trivial" onclick="toggleBtnTrivial()">Trivial</label>

      <input id="easy" name="state-d" type="radio" checked="" />
      <label for="easy" onclick="toggleBtnEasy()">Easy</label>

      <input id="tamper" name="state-d" type="radio" checked="" />
      <label for="tamper" class="disabled" onclick="toggleBtnTamper()">Tamper</label>

      <input id="insider_attack" name="state-d" type="radio" checked="checked" />
      <label for="insider_attack" class="disabled" onclick="toggleBtnInsider()">Insider Attack</label>

      <input id="secure" name="state-d" type="radio" />
      <label for="secure" onclick="toggleBtnSecure()">Secure</label>

      </div>
<br>



    <br>
    Your AWS Account Id <div class="tooltip">
               <small type="text">Guess the account Id</small>
               <span class="tooltiptext">See the policy below</span>
                        </div>
    <br>
    <input type="text" id="input_account" placeholder="eg. 123456789012">
    <span id="output"></span>
    <br>
    Role Name <very-small>You create this in your account for Super Secure Cloud to access your data</very-small>
    <br>
    <input type="text" id="role" placeholder="eg. SSC_role">
    <span id="input_role"></span>
    <br>

    ExternaId <small>Copy the ExternalID into your policy in the AWS Console</small>

    <div id="externalid-button" class="grey-input">     
   
    <small type="text" id="input_external_id" >SecureCloud</small>
    </div>

    <button id="regenerate-btn">Regenerate External ID</button>
    <button id="test-connection-btn">Test Connection</button>
    <br>
    <small type="text">SSC_role Assume Role Trust Policy in Victim Account AWS Portal</small><br>
    <small type="text">(the attacker cannot change this)</small>
    <small id="AWSPolicy" class="grey-input"></small>


<!--  Add your javascript here
 -->
 <script type="text/javascript" id="highlight">
   highlight = function(jsonString, searchFor) {
    var regex = new RegExp(searchFor, 'g');
    //var highlighted = '</div><div style="text-indent: 40px;"><span class="highlighted">' + searchFor + '</span></div><div style="text-indent: 40px;">';
    var highlighted = '<span class="highlighted">' + searchFor + '</span>';
    var newJsonString = jsonString.replace(regex, highlighted);
    return prettyPrintOne(newJsonString);
  };
  
  var highlightLine = function(jsonString, searchFor) {
    var regex = new RegExp('(.*' + searchFor + '.*)', 'g');
    var highlighted = '<span class="highlighted">$1</span>';
    var newJsonString = jsonString.replace(regex, highlighted);
    console.log(jsonString.match(regex));
    return prettyPrintOne(newJsonString);
  };
  
  var renderJson = function() {
    var externalIdValue = document.getElementById('input_external_id').innerHTML;
    // "fc2a0258-aee3-41f9-a37a-7db9c9e16cee"

    var jsonVar = {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "AWS": "999999999999"
          },
          "Action": "sts\:AssumeRole",
          "Condition": {
            "StringLike": {
              "sts:ExternalId": ["fc2a0258-aee3-41f9-a37a-7db9c9e16cee"]
            }
          }
        }
      ]
    };
    jsonVar['Statement'][0]['Condition']['StringLike']['sts:ExternalId'][0] = externalIdValue;
    jsonStr = JSON.stringify(jsonVar);
    // $('#jsonCode').html(highlight(jsonString, 'X-RateLimit'));
    // $('#jsonCode2').html(highlightLine(jsonString, 'follow'));
    regeStr = '', // A EMPTY STRING TO EVENTUALLY HOLD THE FORMATTED STRINGIFIED OBJECT
    f = {
            brace: 0,
            bracket: 0
        }; // AN OBJECT FOR TRACKING INCREMENTS/DECREMENTS,
           // IN PARTICULAR CURLY BRACES (OTHER PROPERTIES COULD BE ADDED)

    regeStr = jsonStr.replace(/({|}[,]*|[^{}]+:[^{}:,]*[,{]*)/g, function (m, p1) {
        var rtnFn = function(token) {
            if (token === 'brace') {
              return '<div style="text-indent: ' + (f['brace'] * 20) + 'px;">' + p1 + '</div>';
            } else {
              return '<div style="text-indent: ' + (f['bracket'] * 20) + 'px;">' + p1 + '</div>';

            }
        },
        rtnStr = 0;
        if (p1.lastIndexOf('{') === (p1.length - 1)) {
            rtnStr = rtnFn('brace');
            f['brace'] += 1;
        } else if (p1.indexOf('}') === 0) {
             f['brace'] -= 1;
            rtnStr = rtnFn('brace');
        }
        // else if (p1.lastIndexOf('[') === (p1.length - 1)) {
        //     rtnStr = rtnFn('bracket');
        //     f['bracket'] += 1;
        // } 
        // else if (p1.indexOf(']') === 0) {
        //      f['bracket'] -= 1;
        //     rtnStr = rtnFn('bracket');
        // } 
        else {
            rtnStr = rtnFn('brace');
        }
        return rtnStr;
    });
    console.log(highlight(regeStr, externalIdValue));
    document.getElementById('AWSPolicy').innerHTML = highlight(regeStr, externalIdValue)
  };
   renderJson();
    </script>


<script>
  function resetState () {
      document.getElementById('test-connection-btn').class_name = 'green-button';
      document.getElementById('test-connection-btn').innerHTML = 'Test Connection';
      renderJson();
  };

  function toggleBtnTrivial() {
    document.getElementById('input_external_id').innerHTML = "SecureCloud";
    resetState();
    document.getElementById('input_external_id').class_name = 'input';
    renderJson();    
  };
  function toggleBtnEasy() {
    document.getElementById('input_external_id').innerHTML = "eg. SecureCloud_production";
    resetState();
  };
  function toggleBtnTamper() {
    document.getElementById('input_external_id').innerHTML = uuidv4();
    resetState();  
  };
  function toggleBtnInsider() {
    document.getElementById('input_external_id').innerHTML = uuidv4();
    resetState();
  };
  function toggleBtnSecure() {
    document.getElementById('input_external_id').innerHTML = uuidv4();
    resetState();
    renderJson();
  };


</script>



    <!-- Test Connection -> Success; Someday real test -->
    <script type="text/python" id="script0">
        from browser import document, console, alert

        def show(e):
            console.log(e)
            input_external_id = document["input_external_id"].text
            console.log(input_external_id)
            #if input_externalId == "SecureCloud": 
            #    document["test-connection-btn"].class_name = "green-button"
            #   document['test-connection-btn'].text = 'Success!'
            #else:
            document['test-connection-btn'].class_name = 'red-button'
            document['test-connection-btn'].text = 'Connection Failed!'
            console.log(document['test-connection-btn'])

        document['test-connection-btn'].bind('click', show)
        

        '''
        from browser import document, ajax, console
        from browser.template import Template

        url = 'https://api.chucknorris.io/jokes/random'

        def on_complete(req):
            import json
            data = json.loads(req.responseText)
            joke = data['value']
            document['joke'].text = joke

        def get_joke(e):
            req = ajax.ajax()
            req.open('GET', url, True)
            req.bind('complete', on_complete)
            document['joke'].text = 'Loading...'
            req.send()

            import uuid, random
            uuid_val = str(uuid.uuid4())
            console.log(uuid_val)
            Template(document['greet']).render(name=uuid_val)

        document['regenerate-btn'].bind('click', get_joke) '''

    </script>

    <!-- Unused Text bind -->
    <script type="text/python" id="script1">
        from browser import document

        def show_text(e):
            document['output'].textContent = e.target.value;

        document['text'].bind('input', show_text)
    </script>



    
    <script type="text/python" id="script2">
        from browser import document, console, window
        from browser.template import Template
        uuid_val = '22813a05-959f-4a1e-9698-fc811388c298'
        console.log(uuid_val)

        def regenerate_externalid(e):
            uuid_val = window.uuidv4()
            console.log(uuid_val)
            document["input_external_id"].text = uuid_val

        document['regenerate-btn'].bind('click', regenerate_externalid)

    </script>

    <!-- Ajax call -->
    <script type="text/python" id="script3">
        from browser import document, ajax, console
        from browser.template import Template

        url = 'https://api.chucknorris.io/jokes/random'

        def on_complete(req):
            import json
            data = json.loads(req.responseText)
            joke = data['value']
            document['joke'].text = joke

        def get_joke(e):
            req = ajax.ajax()
            req.open('GET', url, True)
            req.bind('complete', on_complete)
            document['joke'].text = 'Loading...'
            req.send()

            import uuid, random
            uuid_val = str(uuid.uuid4())
            console.log(uuid_val)
            Template(document['greet']).render(name=uuid_val)

        #document['regenerate-btn'].bind('click', get_joke)
    </script>






</body>
</html>

