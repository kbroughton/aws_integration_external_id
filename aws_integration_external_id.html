<!DOCTYPE html>
<!-- Brython code comes from https://www.youtube.com/watch?v=VJj-H4we71g -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.8.8/brython.js" integrity="sha256-rA89wPrTJJQFWJaZveKW8jpdmC3t5F9rRkPyBjz8G04=" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.8.8/brython_stdlib.js" integrity="sha256-Gnrw9tIjrsXcZSCh/wos5Jrpn0bNVNFJuNJI9d71TDs=" crossorigin="anonymous"></script>

    <style>
          * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 25px;
            padding: 30px;
            line-height: 1.6;
        }

        small {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 15px;
            padding: 20px;
            line-height: 1.1;
        }

        very-small {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 10px;
            padding: 2px;
            line-height: 0.9;
        }

        h1 {
          text-align: center;
          margin-bottom: 30px;
          border-bottom: 1px #ccc solid;
        }

        h2 {
          margin-top: 20px;
        }
      
      .grey-input {
          background-color: #e7e7e7; 
          color: black; /* Gray */
          margin: 1px 0;
          padding: 1px 1px;
          width: 550px;   
          display: block;
        font-size: 15px;
          } 

      .white-input[type="text"] {
          border: 1px #ccc solid;
          width: 300px;
          padding: 4px;
          height: 35px;
          margin-top: 10px;
          opacity: 0.9;
        }

      .policy {
          background-color: #e7e7e7; 
          color: black; /* Gray */
          margin: 1px 0;
          padding: 1px 1px;
          width: 550px;   
          display: block;

          } 

        button {
          cursor: pointer;
          display: inline-block;
          background-color: #24a0ed; 
          border: 0;
          border-radius: 5px;
          padding: 10px 20px;
          margin: 20px 0;
        }

          .green-button {
          cursor: pointer;
          display: inline-block;
          background-color: #4CAF50; /* Green */
          border: 0;
          border-radius: 5px;
          padding: 10px 20px;
          margin: 20px 0;
        }

          .red-button {
          cursor: pointer;
          display: inline-block;
          background-color: #D01010; /* RED */
          border: 0;
          border-radius: 5px;
          padding: 10px 20px;
          margin: 20px 0;
        }     

        .white-button {
          cursor: pointer;
          display: inline-block;
          background-color: #FFFFFF; /* White */
          border: 2px solid #00AF50;
          border-radius: 5px;
          padding: 2px 4px;
          margin: 2px;
          border-color: #FF0000;
          color: black;
        }   

        input[type="text"] {
          border: 1px #ccc solid;
          width: 350px;
          padding: 4px;
          height: 35px;
          margin-top: 10px;
          opacity: 0.9;
        }


      #overlay {
        display: none;
        position: absolute;
        width: 100px;
        height: 100px;
        background-color: gray;
        top: 50px;
        left: 50px;
        padding: 10px;
        opacity: .8;
      }
        .card {
          margin: 20px 0;
          border: #ccc 1px solid;
          padding: 20px;
        }

        .box {
            background: steelblue;
            width: 1.6em;
            height: 1.6em;
        }

    .switch-toggle {
      float: left;
      background: #242729;
    }
    .switch-toggle input {
      position: absolute;
      opacity: 0;
    }
    .switch-toggle input + label {
      padding: 7px;
      float:left;
      color: #fff;
      cursor: pointer;
    }
    .switch-toggle input:checked + label {
      background: blue;
  }
  .highlighted {
    background-color: #ff0;
  }
  /* Tooltip container */
  .tooltip {
    position: relative;
    display: inline-block;
    border: 1px black; /* If you want dots under the hoverable text */
    /*border-top: 2px solid #000;*/
  }
  .visible {
    display: block;
  }
  .hidden {
    display: none;
  }

  /* Tooltip text */
  .tooltip .tooltiptext {
    visibility: hidden;
    width: 320px;
    background-color: #FFFFA0; 
    color: #000000;
    text-align: center;
    padding: 10px 0;
    border-radius: 6px solid #000;

    /* Position the tooltip text */
    position: absolute;
    z-index: 1;
    bottom: 10%;
    left: 50%;
    margin-left: 75px;
    margin-bottom: -560px;

    /* Fade in tooltip */
    opacity: 0;
    transition: opacity 0.3s;
  }

  /* Tooltip arrow */
  .tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    top: 200%;
    left: 250%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #555 transparent transparent transparent;
  }

  /* Show the tooltip text when you mouse over the tooltip container */
  .tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
  }

  .show-btn {
    display: inline-block;
  }

  .hide-btn {
    display: none;
  }

    </style>

        <!-- <script data-require="jquery" data-semver="2.0.3" src="http://code.jquery.com/jquery-2.0.3.min.js"></script> -->

    <script type="text/javascript" id="uuid_script">

        function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
        });

        }

    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.js"></script>

    <title>Confused Deputy Demo</title>

    </head>
    <body onload="brython()">
        <h1>Super Secure Your Cloud We Will Make</h1>

     <div class="switch-toggle switch-3 switch-candy">

      <input id="trivial" name="state-d" type="radio" checked="checked" />
      <label for="trivial" onclick="toggleBtnTrivial()">Trivial</label>

      <input id="easy" class="disabled" name="state-d" type="radio" />
      <label for="easy" onclick="toggleBtnEasy()">Easy</label>

      <input id="tamper" class="disabled" name="state-d" type="radio" />
      <label for="tamper" onclick="toggleBtnTamper()">Tamper</label>

      <input id="insider_attack" class="disabled" name="state-d" type="radio"  />
      <label for="insider_attack" onclick="toggleBtnInsider()">Insider Attack</label>

      <input id="secure" class="disabled" name="state-d" type="radio" />
      <label for="secure" onclick="toggleBtnSecure()">Secure</label>

      </div>
<br>


    <script id="global-js">
      var game_state = "Trivial"
    </script>

    <br>
    Your AWS Account Id <div class="tooltip" value="">
               <button id="guess_account_id" type="text" class="white-button">Guess the account Id</button>
               <span class="tooltiptext">It must match the policy below. Blog coming soon: A million and one ways to find AWS Account IDs.</span>
                        </div>
    <br>
    <input type="text" id="account_id" placeholder="eg. 123456789012" value="">
    <span id="output"></span>
    <br>
    Role Name <very-small>You create this in your account for Super Secure Cloud to access your data</very-small>
    <br>
    <input type="text" id="role" placeholder="eg. SSC_role" value="">
    <span id="input_role"></span> 
    <div class="tooltip" value="" visibility="hidden">
      <button id="brute_force_role" type="text" class="white-button" visibility="hidden">
      Brute for the role</button>
      <span class="tooltiptext">Click to simulate running Pacu to brute-force the role name</span>
    </div>
    <br>
    ExternalId <very-small>Copy the ExternalID into your policy in the AWS Console</very-small>

    <br>
    <input type="text" id="input_external_id" value="SecureCloud" placeholder="SecureCloud" class="grey-input" readonly>
    <span id="input_external"></span>

    <button id="test-connection-btn">Test Connection</button>
    <button id="regenerate-btn" visibility="hidden" class="show-secure hide-btn">Regenerate External ID</button>
    <br>

    <script>
      function setImageVisible(id, visible) {
    var img = document.getElementById(id);
    img.style.visibility = (visible ? 'visible' : 'hidden');
    }
    </script>

    <img id="intercepted" src="burp_intercepted.png" visibility="hidden" style="display:none">
    <img id="changed" src="burp_changed.png" visibility="hidden" style="display:none">

    <hr style="height:2px;border-width:1;color:orange">

    <div width: 320px padding="10px" border="5px solid orange" margin="0">

      <small type="text" padding="0px">SSC_role Assume Role Trust Policy in Victim Account AWS Portal</small><br>
      <very-small type="text">role: SSC_role  (the attacker cannot change this)</very-small>
      <pre id="AWSPolicy" class="grey-input"></pre>
    </div>




<!--  Add your javascript here
 -->
 <script type="text/javascript" id="highlight">
   highlight = function(jsonString, searchFor) {
    var regex = new RegExp(searchFor, 'g');
    var highlighted = '<span class="highlighted">' + searchFor + '</span>';
    var newJsonString = jsonString.replace(regex, highlighted);
    return prettyPrintOne(newJsonString);
  };
  
  var highlightLine = function(jsonString, searchFor) {
    var regex = new RegExp('(.*' + searchFor + '.*)', 'g');
    var highlighted = '<span class="highlighted">$1</span>';
    var newJsonString = jsonString.replace(regex, highlighted);
    console.log(jsonString.match(regex));
    return prettyPrintOne(newJsonString);
  };
  var input_external_id = document.getElementById('input_external_id').innerHTML;
  var external_id_policy_value = "SecureCloud";

  var renderJson = function() {

    console.log("exteranl_id_policy_value " + window.external_id_policy_value)
    console.log("input_external_id " + document.getElementById("input_external_id").value);

    var jsonVar = {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "AWS": "arn:aws:iam::999999999999:root"
          },
          "Action": "sts:AssumeRole",
          "Condition": {
            "StringLike": {
              "sts:ExternalId": ["SecureCloud"]
            }
          }
        }
      ]
    };

    jsonVar['Statement'][0]['Condition']['StringLike']['sts:ExternalId'][0] = window.external_id_policy_value;

    jsonStr = JSON.stringify(jsonVar, null, 2);

    var hlight = highlight(jsonStr, window.external_id_policy_value);
    document.getElementById('AWSPolicy').innerHTML = hlight;
  };
   renderJson();
    </script>


<script>
  function resetState () {
      setImageVisible('intercepted', false)
      setImageVisible('changed', false)
      document.getElementById('test-connection-btn').style.backgroundColor = '#24a0ed';
      document.getElementById('test-connection-btn').innerHTML = 'Test Connection';
      document.getElementById('input_external_id').value = "" ;  
      renderJson();
  };
 
  function setExternalBox (color) {
    if (color === 'white') {
      document.getElementById('input_external_id').class_name = 'white-input';
      document.getElementById('input_external_id').style.backgroundColor = "white";
      document.getElementById('input_external_id').removeAttribute('readonly');
    } else {
      document.getElementById('input_external_id').style.backgroundColor = "lightgrey";
      document.getElementById('input_external_id').setAttribute('readonly', true);
    }

  };

  function toggleBtnTrivial() {
    window.game_state = "Trivial"
    document.getElementById('input_external_id').setAttribute('placeholder', "SecureCloud");  
    window.external_id_policy_value = "SecureCloud"
    resetState();
    setExternalBox('white');
    var btn = document.getElementById('regenerate-btn');
    btn.classList.add('hide-btn');
    btn.classList.remove('show-btn');
  };
  function toggleBtnEasy() {
    window.game_state = "Easy"
    document.getElementById('input_external_id').setAttribute('placeholder', "eg. SecureCloud_prod");  
    window.external_id_policy_value = "SecureCloud_Dev"
    resetState();
    setExternalBox('white');
    var btn = document.getElementById('regenerate-btn');
    btn.classList.add('hide-btn');
    btn.classList.remove('show-btn');
  };
  function toggleBtnTamper() {
    window.game_state = "Tamper"
    document.getElementById('input_external_id').setAttribute('placeholder', "22813a05-959f-4a1e-9698-fc811388c298");  
    window.external_id_policy_value = "fc2a0258-aee3-41f9-a37a-7db9c9e16cee"
    resetState();
    setExternalBox('grey');
    var btn = document.getElementById('regenerate-btn');
    btn.classList.add('hide-btn');
    btn.classList.remove('show-btn');
  };
  function toggleBtnInsider() {
    window.game_state = "Insider"
    var ext = uuidv4();
    document.getElementById('input_external_id').setAttribute('placeholder', ext);  
    window.external_id_policy_value = 'fc2a0258-aee3-41f9-a37a-7db9c9e16cee';
    resetState();
    setExternalBox('white');
    var btn = document.getElementById('regenerate-btn');
    btn.classList.add('hide-btn');
    btn.classList.remove('show-btn');
  };
  function toggleBtnSecure() {
    window.game_state = "Secure"
    var ext = uuidv4();
    document.getElementById('input_external_id').setAttribute('placeholder',  ext);
    window.external_id_policy_value = 'fc2a0258-aee3-41f9-a37a-7db9c9e16cee';
    resetState();
    setExternalBox('grey');
    var btn = document.getElementById('regenerate-btn');
    btn.classList.remove('hide-btn');
    btn.classList.add('show-btn');
  };

</script>

    <script type="text/python" id="guess_account_id_script">
      from browser import document, console, alert, window, timer

      def guess_account(e):
          if document['account_id'].value == "":
              document['account_id'].value = "513589784635"
              document['account_id'].text = "513589784635"
          else:  
              # document['account_id'].value == "513589784635":
              document['account_id'].value = "999999999999"
          console.log("guess_account " + document['account_id'].value)

      document['guess_account_id'].bind('click', guess_account)

    </script>

<!--       This is intended to set the value, wait a split second then repeat
      five times until it settles on SSC_role. WIP, not working yet. -->
    <script type="text/python" id="brute_force_role_script">

      from browser import document, console, alert, window, timer

      def set_role_value(value):
          #document['role'].text = value
          document['role'].value = value   
          console.log(document['role'].value)

      def brute_force_role(e):
          for role in ["SSC", "SSC-role", "SecureCloud-role", "SecureCloudRole", "SSC_role_Dev", "SSC_role_prod", "SSC_role"]: 
              timer.set_timeout(set_role_value(role), 1000)

      document['brute_force_role'].bind('click', brute_force_role)

    </script>

    <!-- Test Connection -> Success; Someday real test -->
    <script type="text/python" id="test_connection">
        from browser import document, console, alert, window, timer

        def reset_button():
            document['test-connection-btn'].style.backgroundColor = "#24a0ed"
            document['test-connection-btn'].text = 'Test Connection'          

        def set_image_visible(image_id, value):
            visibility = 'hidden'
            display = "none"
            if value:
                visibility = 'visible'
                display = "block"
            document[image_id].style.visibility = visibility
            document[image_id].style.display = display

        def dummy():
            print("here")
            


        def test_connection():
            game_state = window.game_state
            if game_state == "Tamper":
                set_image_visible('intercepted', True)
                timer.set_timeout(dummy, 2000)
                #set_image_visible('intercepted', False)
                set_image_visible('changed', True)
                timer.set_timeout(dummy, 2000)
                #set_image_visible('changed', False)
                return True

            input_external_id = document["input_external_id"].value
            input_role = document["role"].value
            input_account_id = document["account_id"].value
            if (input_external_id == window.external_id_policy_value) and \
               (input_role == "SSC_role") and \
               (input_account_id == "999999999999"):
                return True
            else:
                return False

        def show(e):
            console.log(e)
            input_external_id = document["input_external_id"].value
            console.log("TEST")
            console.log(input_external_id)
            console.log(window.external_id_policy_value)
            #if window.external_id_policy_value == input_external_id: 
            if test_connection(): 
                document["test-connection-btn"].style.backgroundColor = "#4CAF50"
                document['test-connection-btn'].text = 'Success!'
            else:
                document['test-connection-btn'].style.backgroundColor = "#D01010"
                document['test-connection-btn'].text = 'Connection Failed!'
            console.log(document['test-connection-btn'])

            timer.set_timeout(reset_button, 2000)

        document['test-connection-btn'].bind('click', show)
        

        '''
        from browser import document, ajax, console
        from browser.template import Template

        url = 'https://api.chucknorris.io/jokes/random'

        def on_complete(req):
            import json
            data = json.loads(req.responseText)
            joke = data['value']
            document['joke'].text = joke

        def get_joke(e):
            req = ajax.ajax()
            req.open('GET', url, True)
            req.bind('complete', on_complete)
            document['joke'].text = 'Loading...'
            req.send()

            import uuid, random
            uuid_val = str(uuid.uuid4())
            console.log(uuid_val)
            Template(document['greet']).render(name=uuid_val)

        document['regenerate-btn'].bind('click', get_joke) '''

    </script>

    <!-- Unused Text bind -->
    <script type="text/python" id="script1">
        from browser import document

        def show_text(e):
            document['output'].textContent = e.target.value;

        document['output'].bind('input', show_text)
    </script>



    
    <script type="text/python" id="script2">
        from browser import document, console, window
        from browser.template import Template
        uuid_val = '22813a05-959f-4a1e-9698-fc811388c298'
        console.log(uuid_val)

        def regenerate_externalid(e):
            uuid_val = window.uuidv4()
            console.log(uuid_val)
            document["input_external_id"].value = uuid_val

        document['regenerate-btn'].bind('click', regenerate_externalid)

    </script>

    <!-- Ajax call -->
    <script type="text/python" id="script3">
        from browser import document, ajax, console
        from browser.template import Template

        url = 'https://api.chucknorris.io/jokes/random'

        def on_complete(req):
            import json
            data = json.loads(req.responseText)
            joke = data['value']
            document['joke'].text = joke

        def get_joke(e):
            req = ajax.ajax()
            req.open('GET', url, True)
            req.bind('complete', on_complete)
            document['joke'].text = 'Loading...'
            req.send()

            import uuid, random
            uuid_val = str(uuid.uuid4())
            console.log(uuid_val)
            Template(document['greet']).render(name=uuid_val)

        #document['regenerate-btn'].bind('click', get_joke)
    </script>



</body>
</html>

